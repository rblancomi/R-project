---
title: "Simulating pathways, mutual exclusivity, et al."
author: "Raquel Blanco"
date: "1/15/2021"
output:
  pdf_document:
    toc: yes
    latex_engine: xelatex
    fig_caption: yes
    number_sections: yes

bibliography: Bibliografia_R.bib
link-citations: yes
linkcolor: blue
csl: vancouver.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# \textcolor{blue}{Mutal exclusivity and modules} {#one}

## \textcolor{blue}{A probabilistic model of mutually exclusive linearly ordered driver pathways} {#one_one}

Mohaghegh Neyshabouri et al. @Neyshabouri2020 propose a probabilistic model of mutually exclusive linearly ordered driver pathways and analyze two large datasets of colorectal adenocarcinoma (COADREAD) and glioblastoma (GBM) from IntOGen-mutations database. Their model assumes driver genes are over-represented among those mutated across a large tumor collection and, thus, they can be identified in terms of frequency. Also, those participating of the same pathway are mutated in a mutually exclusive manner because more than one mutation in a pathway does not give any selective advantage to the clone.

Like with previous generative models, we map the COADREAD and GMB generative models to actual evolutionary models using different **OncoSimulR** functionalities. This time, we extent what authors model using the mutator and frequency-dependent fitness specifications, to illustrate how differently fitness landscapes evolve even though they are built from exact CPMs when we consider these additional evolutionary phenomena. 

### \textcolor{blue}{Colorectal adenocarcinoma (COADREAD) dataset} {#one_one_one}

#### \textcolor{blue}{Modelling mutual exclusivity and order restrictions} {#one_one_one_one}

Figure 7.C from @Neyshabouri2020 shows the CPM inferred from the COADREAD dataset, consisting of seven modules with between 1 to 4 genes each. The model clearly reconstructs the well-known initiator events in colorectal cancer, including mutations in *APC*, *TP53* and *KRAS* @RefHere. Using the DAG of restrictions as starting point[^1], the evolutionary model is created specifying same genotype fitness for all modules as authors do not state any differences in fitness for when the restrictions in the DAG are satisfied (`s`). However, based on the confidence parameter used by the authors to assess the reliability of modeled restrictions, different fitness are set when the DAG of restrictions is not satisfied (`sh`) (\autoref{table}). Since this method reconstructs linear models (*i.e.* oncogenic trees), there is no need to specify any particular type of dependency between modules (`typeDep`), so we set it to monotonic (MN) as it is a mandatory argument for `allFitnessEffects` function. 

[^1]: Due to memory exhaustion, the following genes from the dataset have been removed: FAT4 (module E), CTNNB1 (module F), TCF7L2 (module E)

Table: confidence parameter for each module transition \label{table}

|                   Module                  |   Confidence parameter (%)    |
| :---------------------------------------: | :---------------------------: |
|                   *APC*                   |             100               |
|                                           |                               |
|                   *TP53*                  |             100               |
|                                           |                               |
|                   *KRAS*                  |             100               |
|                                           |                               |
|         *PIK3CA*, *NRAS*, *LRP1B*         |             100               |
|                                           |                               |
|     *FBXW7*, *TCF7L2*, *FAT4*, *ARID1A*   |             87.7              |
|                                           |                               |
| *ATM*, *SMAD2*, *ERBB3*, *MTOR*, *CTNNB1* |             86.9              |
|                                           |                               |
|               *SOX9*, *SMAD4*             |             66.7              |
```{r}
# Loading library (REMOVE)
library(OncoSimulR)
```

```{r fig1, fig.align="center", fig.cap= "DAG of restrictions for the COADREAD dataset"}

## Restriction table, including DAG of restrictions specifications and associated fitness
COADREAD_rT <- data.frame(parent = c("Root", "A", "B", "C", "D", "E", "F"), # Parent nodes
                             child = c("A", "B", "C", "D", "E", "F", "G"), # Child nodes
                             s = 0.5, 
                             sh = c(rep(-1, 4), rep(-.5, 2), -.2),
                             typeDep = "MN")


## Create fitness specifications from DAG of restrictions considering modules 
COADREAD_fitness <- allFitnessEffects(COADREAD_rT, 
                                         geneToModule = c( "Root" = "Root",
                                                           "A" = "APC",
                                                           "B" = "TP53",
                                                           "C" = "KRAS",
                                                           "D" = "PIK3CA, NRAS, LRP1B",
                                                           "E" = "FBXW7, ARID1A",
                                                           "F" = "ATM, SMAD2, ERBB3, MTOR",
                                                           "G" = "SOX9, SMAD4")) # Modules


## DAG of restrictions representation
plot(COADREAD_fitness, expandModules = TRUE, autofit = TRUE)
```
```{r fig2, fig.align="center", fig.cap= "Fitness landscape corresponding with the DAG of restrictions for the COADREAD dataset"}
# Evaluation of all possible genotypes fitness under the previous fitness specifications
COADREAD_FL <- evalAllGenotypes(COADREAD_fitness, max = 131072)

# Fitness landscape representation
plotFitnessLandscape(COADREAD_FL) 
```
maybe add here an extended explanation (?)

#### \textcolor{blue}{Simplified cancer progression model} {#one_one_one_two}

As we did with previous models, for illustrating purposes we designed a simplified version of the CPM by @Neyshabouri2020 to explore the relationships between modules. Considering each module represents a set of mutually exclusive genes, this simplified version of the model assumes a scenario in which theses genes never mutate at the same time, and thus those genotypes never exist. This way, modules can incorporate a single gene and the relationships between them can be more clearly visualized both in the fitness landscape and in the simulations. Also, we can analyze the different evolutionary scenarios arising from the same set of restrictions but happening for different mutated genes in each module. 

In the simplified version of the CPM, we use the dataframe `COADREAD_rT` without the `geneToModule` specification in the `allFitnessEffects` function. Thus, we visualize "module genotypes" instead of genes. In this first example we assume that the effect each gene in a module has on fitness is the same. 

```{r fig3, fig.align="center", fig.cap= "Simplified DAG of restrictions for the COADREAD dataset"}
## Create fitness specifications from somplified DAG of restrictions
COADREADsim_fitness <- allFitnessEffects(COADREAD_rT)

## Simplified DAG of restrictions representation
plot(COADREADsim_fitness)
```
```{r fig4, fig.align="center", fig.cap= "Fitness landscape corresponding with the simplified DAG of restrictions for the COADREAD dataset"}
# Evaluation of all possible genotypes fitness under the previous fitness specifications
COADREADsim_FL <- evalAllGenotypes(COADREADsim_fitness)

# Fitness landscape representation
plotFitnessLandscape(COADREADsim_FL) 
```
The fitness landscape in \autoref{fig:fig4} more clearly shows how fitness increases with the accumulation of mutations in the order specified in the DAG of restrictions (maybe discuss this a bit more).

Next, we use the simplified fitness landscape to simulate tumor progression for one individual with the `oncoSimulIndiv` functionality. 

```{r fig5, fig.align="center", fig.cap= "Simulation of cancer progression using the fitness landscape of the simplied model for the COADREAD dataset (stacked plot)"}
COADREADsim_Simul <- oncoSimulIndiv(COADREADsim_fitness, 
                           model = "McFL", ## Model used
                           mu = 1e-4, ## Mutation rate
                           sampleEvery = 0.02, ## How often the whole population is sampled
                           keepEvery = 1,
                           initSize = 2000, ## Initial population size
                           finalTime = 200,
                           keepPhylog = TRUE, ## Allow to see parent-child relationships
                           onlyCancer = FALSE)

## Plot of simulation for genotypes
plot(COADREADsim_Simul,
show = "genotypes",
type = "stacked")
```
```{r fig6, fig.align="center", fig.cap= "Simulation of cancer progression using the fitness landscape of the simplified model for the COADREAD dataset (line plot)"}
plot(COADREADsim_Simul, 
     show = "genotypes",
     type = "line"
)
```
```{r fig7, fig.align="center", fig.cap="Parent-child relationship derived from simulation"}
## Parent-child relationship derived from simulation
plotClonePhylog(COADREADsim_Simul,
                N = 0, ## Specify clones that exist
                keepEvents = TRUE ## Arrows showing how many times each clones appeared
)
```
#### \textcolor{blue}{Frequency-dependent fitness} {#one_one_one_two}

Clones that coexist in a tumor can influence the fitness of each other in a frequency-dependent manner when a mutation produces a phenotype able to modulate the tumor microenvironment. OncoSimulR incorporates the `frecuencyDependentFitness` specification to allow for modelling interaction among clones during tumor progression. To further explore this option, we bring back the complete COADREAD evolutionary model and zoom into its five first nodes to model a scenario in which all the possible node-five genotypes coexist at a time and influence each other. For simplicity, we are not using modules this time. 

```{r fig8, fig.align="center", fig.cap="Fitness landscape corresponding with the first-five-nodes possible genotyoes for the COADREAD dataset accounting for frequency-dependent fitness"}

# Mapping of genotypes to frequency-dependent fitness
COADREAD5_gen <- data.frame(Genotype = c("APC, TP53, KRAS",
                                         "APC, TP53, KRAS, PIK3CA",
                                         "APC, TP53, KRAS, NRAS",
                                         "APC, TP53, KRAS, LRP1B"),
                            Fitness = c("1 - (f_APC_TP53_KRAS_PIK3CA + f_APC_TP53_KRAS_NRAS +
                                             f_APC_TP53_KRAS_LRP1B)",
                                        "2 + 1.5 * f_APC_TP53_KRAS_LRP1B",
                                        "2 + 1.1 * f_APC_TP53_KRAS_LRP1B",
                                        "2 - f_APC_TP53_KRAS_NRAS"))


## Evaluate all genotypes considering population sizes of the clones
COADREAD5_FL <- evalAllGenotypes(allFitnessEffects(genotFitness = COADREAD5_gen, 
                                                   frequencyDependentFitness = TRUE,
                                                   frequencyType = "rel"),
                                 spPopSizes = c("APC, TP53, KRAS" = 100,
                                                "APC, TP53, KRAS, PIK3CA" = 20,
                                                "APC, TP53, KRAS, NRAS" = 20,
                                                "APC, TP53, KRAS, LRP1B" = 30))
                                                   

# Fitness landscape representation
plotFitnessLandscape(COADREAD5_FL) 
```
### \textcolor{blue}{Glioblastoma (GBM) dataset} {#one_one_two}



